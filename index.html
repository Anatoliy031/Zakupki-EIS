<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2563eb;--primary-dark:#1e40af;
      --secondary:#10b981;--secondary-dark:#059669;
      --danger:#ef4444;--warning:#f59e0b;
      --dark:#1f2937;--light:#f3f4f6;--border:#e5e7eb;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header,.upload-section,.filters-section,.results-section{background:#fff;border-radius:20px;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,.08);margin-bottom:20px}
    h1{font-size:2.1rem;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{color:#6b7280}
    .upload-area{border:3px dashed var(--border);border-radius:15px;padding:28px;text-align:center;transition:.2s;cursor:pointer;background:linear-gradient(145deg,#f9fafb,#fff)}
    .upload-area:hover{border-color:var(--primary);transform:translateY(-1px)}
    .upload-icon{font-size:2.6rem;color:var(--primary);margin-bottom:10px}
    .file-input{display:none}
    .files-list{list-style:none;margin-top:12px}
    .file-item{background:var(--light);padding:10px 12px;margin:8px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
    .remove-file{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
    .filter-buttons{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px}
    .filter-btn{padding:10px 14px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
    .filter-btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
    .filter-btn.secondary{background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:#fff}
    .filter-btn.warning{background:linear-gradient(135deg,var(--warning),#dc2626);color:#fff}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:8px}
    .stat-card{background:linear-gradient(145deg,#f9fafb,#fff);padding:14px;border-radius:12px;border:1px solid var(--border)}
    .stat-value{font-size:1.4rem;font-weight:800}
    .keyword-search{margin-top:12px;padding:14px;border:1px dashed var(--border);border-radius:12px;background:linear-gradient(145deg,#fafafa,#fff)}
    .section-title{font-weight:700;margin-bottom:6px}
    .keyword-input{width:100%;padding:10px 12px;border:2px solid var(--border);border-radius:10px;font-size:1rem}
    .keyword-input + .keyword-input{margin-top:8px}
    .kw-columns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .kw-col{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .kw-controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;align-items:center}
    .presets{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .presets input[type="text"]{padding:8px 10px;border:2px solid var(--border);border-radius:10px;min-width:220px}
    .results-header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .search-input{flex:1;min-width:240px;padding:10px 12px;border:2px solid var(--border);border-radius:10px}
    .export-section{display:flex;gap:10px}
    .table-container{overflow:auto;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:12px;position:sticky;top:0;cursor:pointer}
    td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    tr:nth-child(even){background:var(--light)}
    mark{background:#fff59d;padding:0 .2em;border-radius:4px}
    .no-results{text-align:center;color:#6b7280;padding:22px}
    .toast{position:fixed;bottom:24px;right:24px;padding:10px 14px;background:var(--dark);color:#fff;border-radius:10px;opacity:0;transform:translateY(20px);transition:all .25s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--secondary)}
    .toast.error{background:var(--danger)}
    .pivot{margin-top:14px;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fafafa}
    .pivot-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    .pivot select{padding:8px 10px;border:2px solid var(--border);border-radius:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫</h1>
      <p class="subtitle">–§–∏–ª—å—Ç—Ä—ã, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫, –¥–µ–¥—É–ø, —ç–∫—Å–ø–æ—Ä—Ç –∏ —Å–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
    </div>

    <div class="upload-section">
      <h2 style="margin-bottom:8px;">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV-—Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏</p>
        <button class="filter-btn primary" style="margin-top:8px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
      </div>
      <ul class="files-list" id="filesList"></ul>
    </div>

    <div class="filters-section" id="filtersSection" style="display:none;">
      <h2 style="margin-bottom:10px;">üîç –§–∏–ª—å—Ç—Ä—ã –∏ –∞–Ω–∞–ª–∏–∑</h2>

      <div class="filter-buttons">
        <button class="filter-btn primary"   onclick="applyFilter('street')">üí° –£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (–Ω–∞—Ä—É–∂*)</button>
        <button class="filter-btn secondary" onclick="applyFilter('smr')">üîß –°–ú–† (–ö–õ-, –í–õ-, –¢–ü, –ë–ö–¢–ü)</button>
        <button class="filter-btn warning"   onclick="applyFilter('all')">üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
        <button class="filter-btn warning"   onclick="resetFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        <button class="filter-btn secondary" onclick="deduplicate()">üßπ –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
      </div>

      <div class="stats" id="stats"></div>

      <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º -->
      <div class="keyword-search">
        <div class="section-title">üîé –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</div>

        <!-- –í–∫–ª—é—á–∞—é—â–∏–µ —Å–ª–æ–≤–∞ -->
        <div id="keywordInclude">
          <input type="text" class="keyword-input" placeholder="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–≤–∫–ª—é—á–∏—Ç—å)">
        </div>
        <div class="kw-controls">
          <button class="filter-btn secondary" type="button" onclick="addKeywordField('include')">+ –ø–æ–ª–µ (–≤–∫–ª—é—á–∏—Ç—å)</button>
        </div>

        <!-- –ò—Å–∫–ª—é—á–∞—é—â–∏–µ —Å–ª–æ–≤–∞ -->
        <div class="section-title" style="margin-top:6px;">üö´ –ò—Å–∫–ª—é—á–∏—Ç—å —Å–ª–æ–≤–∞ (NOT)</div>
        <div id="keywordExclude">
          <input type="text" class="keyword-input" placeholder="–°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è">
        </div>
        <div class="kw-controls">
          <button class="filter-btn secondary" type="button" onclick="addKeywordField('exclude')">+ –ø–æ–ª–µ (–∏—Å–∫–ª—é—á–∏—Ç—å)</button>
        </div>

        <!-- –ö–æ–ª–æ–Ω–∫–∏ -->
        <div class="section-title" style="margin-top:6px;">–ò—Å–∫–∞—Ç—å –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö</div>
        <div id="kwColumns" class="kw-columns"></div>

        <!-- –†–µ–∂–∏–º—ã –ø–æ–∏—Å–∫–∞ -->
        <div class="kw-controls">
          <div><strong>–õ–æ–≥–∏–∫–∞:</strong>
            <label style="margin-left:6px;"><input type="radio" name="kwLogic" value="OR" checked> –ò–õ–ò</label>
            <label style="margin-left:8px;"><input type="radio" name="kwLogic" value="AND"> –ò</label>
          </div>
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="kwStrict"> –°—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤
          </label>
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="kwHighlight"> –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
          </label>

          <button class="filter-btn primary" type="button" onclick="performKeywordSearch()">üîé –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </div>

        <!-- –ü—Ä–µ—Å–µ—Ç—ã -->
        <div class="presets">
          <input id="presetName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–ú–†+–ö–õ)" />
          <button class="filter-btn secondary" type="button" onclick="savePreset()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç</button>
          <select id="presetSelect"></select>
          <button class="filter-btn secondary" type="button" onclick="loadPreset()">‚§¥ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button class="filter-btn warning"   type="button" onclick="deletePreset()">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>

      <!-- –ü–∏–≤–æ—Ç-—Å–≤–æ–¥–∫–∞ -->
      <div class="pivot">
        <div class="section-title">üìà –ü–∏–≤–æ—Ç-—Å–≤–æ–¥–∫–∞</div>
        <div class="pivot-controls">
          <div>
            –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ:
            <select id="pivotGroupBy"></select>
          </div>
          <div>
            –ó–Ω–∞—á–µ–Ω–∏–µ (—Å—É–º–º–∞):
            <select id="pivotValue">
              <option>–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</option>
            </select>
          </div>
          <button class="filter-btn secondary" type="button" onclick="buildPivot()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–¥–∫—É</button>
        </div>
        <div id="pivotTable"></div>
      </div>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º...">
        <div class="export-section">
          <button class="filter-btn secondary" onclick="toggleColumnSelector()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="filter-btn secondary" onclick="exportToCSV()">‚¨áÔ∏è CSV</button>
          <button class="filter-btn secondary" onclick="exportToXLSX()">‚¨áÔ∏è XLSX</button>
        </div>
      </div>

      <div class="column-selector" id="columnSelector" style="display:none;">
        <h3>–ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞</h3>
        <div class="columns-grid" id="columnsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;"></div>
      </div>

      <div class="table-container">
        <table id="resultsTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="no-results" id="noResults" style="display:none;">
        üòï –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò–∑–º–µ–Ω–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let allData = [];
    let filteredData = [];
    let selectedColumns = [];
    let sortColumn = '';
    let sortDirection = 'asc';
    let currentFilter = '';

    const defaultKeywordColumns = [
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏',
      '–û–ø–∏—Å–∞–Ω–∏–µ',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
      '–ú–µ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤–∫–∏'
    ];
    let keywordSearchColumns = new Set(); // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞

    document.addEventListener('DOMContentLoaded', () => {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput  = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e)=>handleFiles(e.target.files));
      uploadArea.addEventListener('dragover',(e)=>{e.preventDefault();uploadArea.classList.add('dragover')});
      uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop',(e)=>{e.preventDefault();uploadArea.classList.remove('dragover');handleFiles(e.dataTransfer.files)});

      document.getElementById('searchInput').addEventListener('input', (e) => searchTable(e.target.value));

      // –ø—Ä–µ—Å–µ—Ç—ã
      hydratePresetSelect();
    });

    async function handleFiles(files){
      const filesList = document.getElementById('filesList');
      const filtersSection = document.getElementById('filtersSection');
      showToast('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');

      for (let file of files){
        if (file.type === 'text/csv' || file.name.endsWith('.csv')){
          const li = document.createElement('li');
          li.className = 'file-item';
          li.innerHTML = `
            <div class="file-info">
              <span>üìÑ</span>
              <div>
                <div style="font-weight:600;">${file.name}</div>
                <div style="color:#6b7280;font-size:.9rem;">${(file.size/1024).toFixed(2)} –ö–ë</div>
              </div>
            </div>
            <button class="remove-file" onclick="removeFile(this)" data-file="${file.name}">‚úï</button>`;
          filesList.appendChild(li);
          await parseCSVFile(file);
        }
      }

      if (allData.length){
        filtersSection.style.display = 'block';
        currentFilter = 'all';
        setupColumns();
        setupKeywordColumnsChips();
        updateStats();
        filteredData = [...allData];
        displayResults(filteredData);
        hydratePivotSelectors();
        showToast('–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
      }
    }

    async function parseCSVFile(file){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          Papa.parse(text, {
            header:true, delimiter:';', skipEmptyLines:true, dynamicTyping:true, encoding:'windows-1251',
            complete: (results) => {
              results.data.forEach(row => { row['–ò—Å—Ç–æ—á–Ω–∏–∫'] = file.name; });
              allData = [...allData, ...results.data];
              resolve();
            }
          });
        };
        reader.readAsText(file, 'windows-1251');
      });
    }

    function removeFile(btn){
      const fileName = btn.getAttribute('data-file');
      allData = allData.filter(row => row['–ò—Å—Ç–æ—á–Ω–∏–∫'] !== fileName);
      btn.parentElement.remove();
      if (!allData.length){
        document.getElementById('filtersSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
      } else {
        updateStats();
        filteredData = [...allData];
        displayResults(filteredData);
        setupKeywordColumnsChips();
        hydratePivotSelectors();
      }
    }

    function updateStats(){
      const streetCount = allData.filter(row =>
        row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
        String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
      ).length;

      const smrCount = allData.filter(row => {
        const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
        if (!name) return false;
        const low = String(name).toLowerCase();
        return (String(name).includes('–ö–õ-') ||
                String(name).includes('–í–õ-') ||
                (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                String(name).includes('–ë–ö–¢–ü'));
      }).length;

      const totalSum = allData.reduce((sum, row) => sum + (Number(row['–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞']) || 0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${allData.length}</div><div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div></div>
        <div class="stat-card"><div class="stat-value">${streetCount}</div><div class="stat-label">–£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</div></div>
        <div class="stat-card"><div class="stat-value">${smrCount}</div><div class="stat-label">–°–ú–†</div></div>
        <div class="stat-card"><div class="stat-value">${formatMoney(totalSum)}</div><div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div></div>`;
    }

    function setupColumns(){
      if (!allData.length) return;
      const columns = Object.keys(allData[0]);
      selectedColumns = [
        '–†–µ–µ—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
        '–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞','–î–∞—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è','–≠—Ç–∞–ø –∑–∞–∫—É–ø–∫–∏','–ò—Å—Ç–æ—á–Ω–∏–∫'
      ].filter(c => columns.includes(c));
      columns.forEach(c => { if (!selectedColumns.includes(c)) selectedColumns.push(c); });

      const grid = document.getElementById('columnsGrid');
      grid.innerHTML = '';
      selectedColumns.forEach(col => {
        const id = `col_${col.replace(/\s/g,'_')}`;
        const div = document.createElement('div');
        div.innerHTML = `<label style="display:flex;gap:8px;align-items:center;padding:6px 8px;background:#fff;border:1px solid var(--border);border-radius:10px;">
          <input type="checkbox" id="${id}" value="${col}" checked onchange="updateSelectedColumns()">
          ${col}</label>`;
        grid.appendChild(div);
      });
    }

    function updateSelectedColumns(){
      selectedColumns = [];
      document.querySelectorAll('#columnsGrid input:checked').forEach(cb => selectedColumns.push(cb.value));
      if (filteredData.length) displayResults(filteredData);
    }

    function toggleColumnSelector(){
      const selector = document.getElementById('columnSelector');
      selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    }

    function setupKeywordColumnsChips(){
      const wrap = document.getElementById('kwColumns');
      wrap.innerHTML = '';
      keywordSearchColumns = new Set();

      const available = allData.length ? Object.keys(allData[0]) : [];
      const initial = defaultKeywordColumns.filter(c => available.includes(c));
      if (!initial.length && available.includes('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏')) initial.push('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏');
      initial.forEach(c => keywordSearchColumns.add(c));

      available.forEach(col => {
        const id = `kwcol_${col.replace(/\s/g,'_')}`;
        const el = document.createElement('label');
        el.className = 'kw-col';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${col}" ${keywordSearchColumns.has(col)?'checked':''} onchange="toggleKeywordColumn(this)">
                        <span>${col}</span>`;
        wrap.appendChild(el);
      });
    }

    function toggleKeywordColumn(cb){
      const col = cb.value;
      if (cb.checked) keywordSearchColumns.add(col);
      else keywordSearchColumns.delete(col);
      if (keywordSearchColumns.size === 0){
        cb.checked = true;
        keywordSearchColumns.add(col);
        showToast('–ù—É–∂–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞','error');
      }
    }

    function applyFilter(type){
      currentFilter = type;
      switch(type){
        case 'street':
          filteredData = allData.filter(row =>
            row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
            String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
          );
          showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π —É–ª–∏—á–Ω–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è`,'success');
          break;
        case 'smr':
          filteredData = allData.filter(row => {
            const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
            if (!name) return false;
            const low = String(name).toLowerCase();
            return (String(name).includes('–ö–õ-') ||
                    String(name).includes('–í–õ-') ||
                    (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                    String(name).includes('–ë–ö–¢–ü'));
          });
          showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π –°–ú–†`,'success');
          break;
        case 'all':
        default:
          filteredData = [...allData];
          showToast(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`,'info');
          break;
      }
      sortColumn=''; sortDirection='asc';
      displayResults(filteredData);
    }

    function displayResults(data){
      const resultsSection = document.getElementById('resultsSection');
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const noResults  = document.getElementById('noResults');

      resultsSection.style.display = 'block';

      if (!data || !data.length){
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';

      const displayCols = selectedColumns.filter(col => document.querySelector(`#columnsGrid input[value="${col}"]`)?.checked);
      tableHead.innerHTML = '<tr>' + displayCols.map(col => `<th onclick="sortTable('${col}')">${col} ${getSortIcon(col)}</th>`).join('') + '</tr>';

      // –ø–æ–¥—Å–≤–µ—Ç–∫–∞?
      const highlightOn = document.getElementById('kwHighlight')?.checked;
      const { includeRegs, excludeRegs, includeWords, strict } = currentSearchContext || {};

      tableBody.innerHTML = data.map(row => {
        const tds = displayCols.map(col => {
          const v = row[col];
          let text = v===null||v===undefined ? '' : String(v);
          if (highlightOn && includeWords && includeWords.length){
            if (strict){
              // —Å—Ç—Ä–æ–≥–∏–µ ‚Äî –Ω–∞–±–æ—Ä —Ä–µ–≥–µ–∫—Å–ø–æ–≤ includeRegs
              includeRegs.forEach(re => {
                text = text.replace(re, (m, p1, p2, p3) => `${p1}<mark>${p2}</mark>${p3}`);
              });
            } else {
              includeWords.forEach(w => {
                if (!w) return;
                const re = new RegExp(escapeRegExp(w), 'gi');
                text = text.replace(re, (m)=>`<mark>${m}</mark>`);
              });
            }
          }
          return `<td>${text}</td>`;
        }).join('');
        return `<tr>${tds}</tr>`;
      }).join('');
    }

    function getSortIcon(column){ if (sortColumn !== column) return '‚ÜïÔ∏è'; return sortDirection === 'asc' ? '‚Üë' : '‚Üì'; }

    function sortTable(column){
      if (sortColumn === column) sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc');
      else { sortColumn = column; sortDirection = 'asc'; }
      filteredData.sort((a,b) => compareValues(a[column], b[column]));
      displayResults(filteredData);
    }

    function compareValues(a,b){
      let av=a, bv=b;
      if (av===null||av===undefined) av='';
      if (bv===null||bv===undefined) bv='';
      if (typeof av==='number' && typeof bv==='number') return (sortDirection==='asc'? av-bv : bv-av);
      av=String(av).toLowerCase(); bv=String(bv).toLowerCase();
      return (sortDirection==='asc' ? (av>bv?1:-1):(av<bv?1:-1));
    }

    function searchTable(term){
      if (!term){ displayResults(filteredData); return; }
      const needle = term.toLowerCase();
      const res = filteredData.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(needle)));
      displayResults(res);
    }

    // ===== –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê =====
    function addKeywordField(kind){
      const wrap = document.getElementById(kind==='exclude' ? 'keywordExclude' : 'keywordInclude');
      const input = document.createElement('input');
      input.type='text'; input.className='keyword-input';
      input.placeholder = kind==='exclude' ? '–°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è' : '–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–≤–∫–ª—é—á–∏—Ç—å)';
      wrap.appendChild(input); input.focus();
    }

    let currentSearchContext = null; // –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏

    function performKeywordSearch(){
      const include = [...document.querySelectorAll('#keywordInclude .keyword-input')].map(i=>i.value.trim().toLowerCase()).filter(Boolean);
      const exclude = [...document.querySelectorAll('#keywordExclude .keyword-input')].map(i=>i.value.trim().toLowerCase()).filter(Boolean);

      if (!include.length && !exclude.length){
        showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–≤–∫–ª—é—á–∏—Ç—å/–∏—Å–∫–ª—é—á–∏—Ç—å)','error'); return;
      }

      const logic   = document.querySelector('input[name="kwLogic"]:checked')?.value || 'OR';
      const strict  = document.getElementById('kwStrict').checked;
      const cols    = Array.from(keywordSearchColumns);
      if (!cols.length){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞','error'); return; }

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–≥–µ–∫—Å–ø–æ–≤ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ —Ä–µ–∂–∏–º–∞
      const incRegs = strict ? include.map(k => buildWordRegexForMark(k)) : null;
      const excRegs = strict ? exclude.map(k => buildWordRegex(k)) : null;

      currentFilter = 'keyword';

      filteredData = allData.filter(row => rowMatchesComplex(row, cols, include, exclude, strict, logic, incRegs, excRegs));
      sortColumn=''; sortDirection='asc';

      // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
      currentSearchContext = {
        includeRegs: incRegs,
        excludeRegs: excRegs,
        includeWords: include,
        strict
      };

      showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π –ø–æ —É—Å–ª–æ–≤–∏—è–º –ø–æ–∏—Å–∫–∞`,'success');
      displayResults(filteredData);
    }

    function rowMatchesComplex(row, cols, include, exclude, strict, logic, incRegs, excRegs){
      const values = cols.map(c => String(row[c] ?? '').toLowerCase());

      const includesOK = include.length ? (
        logic==='AND' ? include.every((kw, i) => anyMatch(values, kw, strict, incRegs?.[i])) :
                        include.some((kw, i) => anyMatch(values, kw, strict, incRegs?.[i]))
      ) : true;

      if (!includesOK) return false;

      const excludesOK = exclude.length ? exclude.every((kw, i) => !anyMatch(values, kw, strict, excRegs?.[i])) : true;

      return includesOK && excludesOK;
    }

    function anyMatch(values, kw, strict, reStrict){
      if (strict){
        const re = reStrict || buildWordRegex(kw);
        return values.some(v => re.test(v));
      } else {
        return values.some(v => v.includes(kw));
      }
    }

    // —Å—Ç—Ä–æ–≥–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ —Å–ª–æ–≤–∞ ‚Äî —Ä–µ–≥–µ–∫—Å–ø
    function buildWordRegex(kw){
      const escaped = escapeRegExp(kw);
      const pattern = `(^|[^\\p{L}\\p{N}_])${escaped}([^\\p{L}\\p{N}_]|$)`;
      return new RegExp(pattern,'iu');
    }
    // –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–æ/–ø–æ—Å–ª–µ –∏ —Å–∞–º—É —Å–µ—Ä–µ–¥–∏–Ω—É)
    function buildWordRegexForMark(kw){
      const escaped = escapeRegExp(kw);
      const pattern = `(^|[^\\p{L}\\p{N}_])(${escaped})([^\\p{L}\\p{N}_]|$)`;
      return new RegExp(pattern,'giu');
    }
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    // ===== –ü–†–ï–°–ï–¢–´ =====
    function savePreset(){
      const name = document.getElementById('presetName').value.trim();
      if (!name){ showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–∞','error'); return; }

      const include = [...document.querySelectorAll('#keywordInclude .keyword-input')].map(i=>i.value.trim()).filter(Boolean);
      const exclude = [...document.querySelectorAll('#keywordExclude .keyword-input')].map(i=>i.value.trim()).filter(Boolean);
      const logic   = document.querySelector('input[name="kwLogic"]:checked')?.value || 'OR';
      const strict  = document.getElementById('kwStrict').checked;
      const highlight = document.getElementById('kwHighlight').checked;
      const cols   = Array.from(keywordSearchColumns);

      const preset = { include, exclude, logic, strict, highlight, cols };
      const all = JSON.parse(localStorage.getItem('zak_presets')||'{}');
      all[name] = preset;
      localStorage.setItem('zak_presets', JSON.stringify(all));
      hydratePresetSelect(name);
      showToast('–ü—Ä–µ—Å–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω','success');
    }

    function hydratePresetSelect(selectName){
      const sel = document.getElementById('presetSelect');
      const all = JSON.parse(localStorage.getItem('zak_presets')||'{}');
      sel.innerHTML = Object.keys(all).length ? Object.keys(all).map(n=>`<option>${n}</option>`).join('') : '';
      if (selectName) sel.value = selectName;
    }

    function loadPreset(){
      const sel = document.getElementById('presetSelect');
      const name = sel.value;
      if (!name){ showToast('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞','error'); return; }
      const all = JSON.parse(localStorage.getItem('zak_presets')||'{}');
      const p = all[name]; if (!p) return;

      // –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è
      const incWrap = document.getElementById('keywordInclude'); incWrap.innerHTML='';
      const excWrap = document.getElementById('keywordExclude'); excWrap.innerHTML='';
      (p.include.length? p.include : ['']).forEach(v=>{
        const i=document.createElement('input'); i.type='text'; i.className='keyword-input'; i.value=v; i.placeholder='–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–≤–∫–ª—é—á–∏—Ç—å)'; incWrap.appendChild(i);
      });
      (p.exclude.length? p.exclude : ['']).forEach(v=>{
        const i=document.createElement('input'); i.type='text'; i.className='keyword-input'; i.value=v; i.placeholder='–°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è'; excWrap.appendChild(i);
      });

      document.querySelector(`input[name="kwLogic"][value="${p.logic||'OR'}"]`).checked = true;
      document.getElementById('kwStrict').checked = !!p.strict;
      document.getElementById('kwHighlight').checked = !!p.highlight;

      // –∫–æ–ª–æ–Ω–∫–∏
      keywordSearchColumns = new Set(p.cols||[]);
      setupKeywordColumnsChips(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —á–∏–ø—Å—ã
      // –æ—Ç–º–µ—Ç–∏—Ç—å —á–∏–ø—Å—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º
      Array.from(document.querySelectorAll('#kwColumns input[type="checkbox"]')).forEach(cb=>{
        cb.checked = keywordSearchColumns.has(cb.value);
      });

      showToast('–ü—Ä–µ—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω','success');
    }

    function deletePreset(){
      const sel = document.getElementById('presetSelect');
      const name = sel.value;
      if (!name){ showToast('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ—Å–µ—Ç–∞','error'); return; }
      const all = JSON.parse(localStorage.getItem('zak_presets')||'{}');
      delete all[name];
      localStorage.setItem('zak_presets', JSON.stringify(all));
      hydratePresetSelect();
      showToast('–ü—Ä–µ—Å–µ—Ç —É–¥–∞–ª—ë–Ω','success');
    }

    // ===== –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–Ø =====
    function deduplicate(){
      const key = '–†–µ–µ—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏';
      if (!allData.length || !(key in allData[0])){ showToast('–ö–æ–ª–æ–Ω–∫–∞ —Ä–µ–µ—Å—Ç—Ä–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); return; }
      const seen = new Set(); const newAll = []; let removed = 0;
      for (const row of allData){
        const k = row[key];
        const uid = (k===undefined||k===null) ? `__no_key__${Math.random()}` : String(k).trim();
        if (seen.has(uid)){ removed++; continue; }
        seen.add(uid); newAll.push(row);
      }
      allData = newAll;
      filteredData = [...allData];
      updateStats(); displayResults(filteredData);
      showToast(`–£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${removed}`,'success');
    }

    // ===== –ü–ò–í–û–¢ =====
    function hydratePivotSelectors(){
      const selGroup = document.getElementById('pivotGroupBy');
      const cols = allData.length ? Object.keys(allData[0]) : [];
      selGroup.innerHTML = cols.map(c=>`<option>${c}</option>`).join('');
      const valSel = document.getElementById('pivotValue');
      // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ –≤ —Å–ø–∏—Å–∫–µ
      const v = '–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞';
      if (!cols.includes(v)){
        valSel.innerHTML = cols.map(c=>`<option>${c}</option>`).join('');
      }
    }

    function buildPivot(){
      if (!filteredData.length){ document.getElementById('pivotTable').innerHTML=''; return; }
      const groupCol = document.getElementById('pivotGroupBy').value;
      const valueCol = document.getElementById('pivotValue').value;

      const map = new Map();
      for (const row of filteredData){
        const g = String(row[groupCol] ?? '');
        const val = Number(row[valueCol]) || 0;
        if (!map.has(g)) map.set(g, {count:0, sum:0});
        const o = map.get(g); o.count++; o.sum += val;
      }
      const rows = [...map.entries()].sort((a,b)=>b[1].sum - a[1].sum);

      const html = `
        <div style="overflow:auto;">
          <table style="width:100%;border-collapse:separate;border-spacing:0;">
            <thead>
              <tr>
                <th style="background:#eef2ff;padding:10px;text-align:left;">–ì—Ä—É–ø–ø–∞: ${groupCol}</th>
                <th style="background:#eef2ff;padding:10px;text-align:right;">Count</th>
                <th style="background:#eef2ff;padding:10px;text-align:right;">Sum(${valueCol})</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(([g,v])=>`
                <tr>
                  <td style="padding:8px;border-bottom:1px solid var(--border);">${g}</td>
                  <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right;">${v.count}</td>
                  <td style="padding:8px;border-bottom:1px solid var(--border);text-align:right;">${formatMoney(v.sum)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      document.getElementById('pivotTable').innerHTML = html;
    }

    // ===== –≠–ö–°–ü–û–†–¢–´ =====
    function exportToCSV(){
      if (!filteredData.length){ showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','error'); return; }
      const cols = selectedColumns.filter(c => document.querySelector(`#columnsGrid input[value="${c}"]`)?.checked);
      const out = filteredData.map(r => Object.fromEntries(cols.map(c=>[c,r[c]])));
      const csv = Papa.unparse(out,{delimiter:';',header:true});
      const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const dateStr = new Date().toLocaleDateString('ru-RU').replace(/\./g,'-');
      const filterName = currentFilter==='street'?'–£–ª–∏—á–Ω–æ–µ–û—Å–≤–µ—â–µ–Ω–∏–µ': currentFilter==='smr'?'–°–ú–†': currentFilter==='keyword'?'–ö–ª—é—á–µ–≤—ã–µ–°–ª–æ–≤–∞':'–í—Å–µ';
      a.download = `–†–µ–µ—Å—Ç—Ä_${filterName}_${dateStr}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      showToast('CSV —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω','success');
    }

    function exportToXLSX(){
      if (!filteredData.length){ showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','error'); return; }
      const cols = selectedColumns.filter(c => document.querySelector(`#columnsGrid input[value="${c}"]`)?.checked);
      const out = filteredData.map(r => Object.fromEntries(cols.map(c=>[c,r[c]])));
      const ws = XLSX.utils.json_to_sheet(out);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '–†–µ–µ—Å—Ç—Ä');
      const dateStr = new Date().toLocaleDateString('ru-RU').replace(/\./g,'-');
      const filterName = currentFilter==='street'?'–£–ª–∏—á–Ω–æ–µ–û—Å–≤–µ—â–µ–Ω–∏–µ': currentFilter==='smr'?'–°–ú–†': currentFilter==='keyword'?'–ö–ª—é—á–µ–≤—ã–µ–°–ª–æ–≤–∞':'–í—Å–µ';
      XLSX.writeFile(wb, `–†–µ–µ—Å—Ç—Ä_${filterName}_${dateStr}.xlsx`);
      showToast('XLSX —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω','success');
    }

    // ===== –°–ë–†–û–° =====
    function resetFilters(){
      filteredData = [...allData];
      currentFilter = 'all';

      // –æ—á–∏—Å—Ç–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
      const inc = document.getElementById('keywordInclude'); inc.innerHTML='<input type="text" class="keyword-input" placeholder="–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ (–≤–∫–ª—é—á–∏—Ç—å)">';
      const exc = document.getElementById('keywordExclude'); exc.innerHTML='<input type="text" class="keyword-input" placeholder="–°–ª–æ–≤–æ/—Ñ—Ä–∞–∑–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è">';
      document.querySelector('input[name="kwLogic"][value="OR"]').checked = true;
      document.getElementById('kwStrict').checked = false;
      document.getElementById('kwHighlight').checked = false;

      // –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–∏—Å–∫–∞ ‚Äî –∫ –¥–µ—Ñ–æ–ª—Ç—É
      setupKeywordColumnsChips();

      // —Å—Ç—Ä–æ–∫–æ–≤—ã–π –ø–æ–∏—Å–∫
      const s = document.getElementById('searchInput'); if (s) s.value='';

      // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      sortColumn=''; sortDirection='asc';

      // —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–æ–∫
      const selector = document.getElementById('columnSelector'); if (selector) selector.style.display='none';

      updateStats();
      displayResults(filteredData);
      showToast('–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω','info');
    }

    // ===== –£–¢–ò–õ–´ =====
    function formatMoney(x){
      if (!x) return '‚Äî';
      return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:0,maximumFractionDigits:2}).format(x);
    }
  </script>
</body>
</html>
