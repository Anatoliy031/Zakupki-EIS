<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2563eb;--primary-dark:#1e40af;
      --secondary:#10b981;--secondary-dark:#059669;
      --danger:#ef4444;--warning:#f59e0b;
      --dark:#1f2937;--light:#f3f4f6;--border:#e5e7eb;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px;animation:slideDown .5s ease-out}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    h1{color:var(--dark);font-size:2.2rem;margin-bottom:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:#6b7280}
    .upload-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px}
    .upload-area{border:3px dashed var(--border);border-radius:15px;padding:40px;text-align:center;transition:all .3s ease;cursor:pointer;background:linear-gradient(145deg,#f9fafb,#fff)}
    .upload-area:hover{border-color:var(--primary);background:linear-gradient(145deg,#eff6ff,#fff);transform:translateY(-2px)}
    .upload-area.dragover{border-color:var(--secondary);background:linear-gradient(145deg,#d1fae5,#fff)}
    .upload-icon{font-size:3rem;color:var(--primary);margin-bottom:15px}
    .file-input{display:none}
    .files-list{margin-top:20px;list-style:none}
    .file-item{background:var(--light);padding:15px;margin:10px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
    .file-info{display:flex;gap:15px;align-items:center}
    .remove-file{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
    .filters-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px}
    .filter-buttons{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px}
    .filter-btn{padding:12px 18px;border:none;border-radius:10px;font-weight:600;cursor:pointer}
    .filter-btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
    .filter-btn.secondary{background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:#fff}
    .filter-btn.warning{background:linear-gradient(135deg,var(--warning),#dc2626);color:#fff}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:10px}
    .stat-card{background:linear-gradient(145deg,#f9fafb,#fff);padding:16px;border-radius:12px;border:1px solid var(--border)}
    .stat-value{font-size:1.6rem;font-weight:800;color:var(--dark)}
    .stat-label{color:#6b7280}
    .keyword-search{margin-top:18px;padding:16px;border:1px dashed var(--border);border-radius:12px;background:linear-gradient(145deg,#fafafa,#fff)}
    .keyword-input{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-size:1rem}
    .keyword-input + .keyword-input{margin-top:10px}
    .kw-controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;align-items:center}
    .kw-columns{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .kw-col{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .results-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);display:none}
    .results-header{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    .search-input{flex:1;min-width:240px;padding:10px 14px;border:2px solid var(--border);border-radius:10px}
    .export-section{display:flex;gap:10px}
    .table-container{overflow-x:auto;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:12px;position:sticky;top:0;cursor:pointer}
    td{padding:12px;border-bottom:1px solid var(--border)}
    tr:nth-child(even){background:var(--light)}
    .no-results{text-align:center;color:#6b7280;padding:30px}
    .toast{position:fixed;bottom:30px;right:30px;padding:12px 16px;background:var(--dark);color:#fff;border-radius:10px;opacity:0;transform:translateY(20px);transition:all .25s;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--secondary)}
    .toast.error{background:var(--danger)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫</h1>
      <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è + –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</p>
    </div>

    <div class="upload-section">
      <h2 style="margin-bottom: 14px;">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <p style="margin-bottom:6px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
        <p style="color:#6b7280;">–∏–ª–∏</p>
        <button class="filter-btn primary" style="margin-top:10px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
      </div>
      <ul class="files-list" id="filesList"></ul>
    </div>

    <div class="filters-section" id="filtersSection" style="display:none;">
      <h2 style="margin-bottom: 10px;">üîç –§–∏–ª—å—Ç—Ä—ã –∏ –∞–Ω–∞–ª–∏–∑</h2>
      <div class="filter-buttons">
        <button class="filter-btn primary"   onclick="applyFilter('street')">üí° –£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (–Ω–∞—Ä—É–∂*)</button>
        <button class="filter-btn secondary" onclick="applyFilter('smr')">üîß –°–ú–† (–ö–õ-, –í–õ-, –¢–ü, –ë–ö–¢–ü)</button>
        <button class="filter-btn warning"   onclick="applyFilter('all')">üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
        <button class="filter-btn warning"   onclick="resetFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>

      <div class="stats" id="stats"></div>

      <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º -->
      <div class="keyword-search" id="keywordSearch">
        <h3 style="margin-bottom:6px;">üîé –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</h3>

        <div id="keywordInputs">
          <input type="text" class="keyword-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É">
        </div>

        <!-- –ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
        <div id="kwColumns" class="kw-columns"></div>

        <div class="kw-controls">
          <!-- –õ–æ–≥–∏–∫–∞ –ò/–ò–õ–ò -->
          <div>
            <strong>–õ–æ–≥–∏–∫–∞:</strong>
            <label style="margin-left:8px;"><input type="radio" name="kwLogic" value="OR" checked> –ò–õ–ò</label>
            <label style="margin-left:8px;"><input type="radio" name="kwLogic" value="AND"> –ò</label>
          </div>

          <!-- –°—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ -->
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="kwStrict"> –°—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤
          </label>

          <!-- –ö–Ω–æ–ø–∫–∏ -->
          <button class="filter-btn secondary" id="addKeywordBtn"  type="button">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
          <button class="filter-btn primary"   id="startSearchBtn" type="button">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </div>
      </div>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h2>
        <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º...">
        <div class="export-section">
          <button class="filter-btn secondary" onclick="toggleColumnSelector()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="filter-btn secondary" onclick="exportToCSV()">üíæ –°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
      </div>

      <div class="column-selector" id="columnSelector" style="display:none;">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
        <div class="columns-grid" id="columnsGrid"></div>
      </div>

      <div class="table-container">
        <table id="resultsTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="no-results" id="noResults" style="display:none;">
        <p style="font-size:1.1rem;">üòï –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏.</p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    let allData = [];
    let filteredData = [];
    let selectedColumns = [];
    let sortColumn = '';
    let sortDirection = 'asc';
    let currentFilter = '';

    // –ö–æ–ª–æ–Ω–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö)
    const defaultKeywordColumns = [
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏',
      '–û–ø–∏—Å–∞–Ω–∏–µ',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
      '–ú–µ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤–∫–∏'
    ];
    let keywordSearchColumns = new Set(); // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ (—á–∏–ø—Å—ã)

    document.addEventListener('DOMContentLoaded', () => {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput  = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);

      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

      document.getElementById('searchInput').addEventListener('input', (e) => searchTable(e.target.value));

      document.getElementById('addKeywordBtn').addEventListener('click', addKeywordField);
      document.getElementById('startSearchBtn').addEventListener('click', performKeywordSearch);
    });

    function handleFileSelect(e){ handleFiles(e.target.files); }

    async function handleFiles(files){
      const filesList = document.getElementById('filesList');
      const filtersSection = document.getElementById('filtersSection');
      showToast('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...', 'info');

      for (let file of files){
        if (file.type === 'text/csv' || file.name.endsWith('.csv')){
          const li = document.createElement('li');
          li.className = 'file-item';
          li.innerHTML = `
            <div class="file-info">
              <span class="file-icon">üìÑ</span>
              <div>
                <div style="font-weight:600;">${file.name}</div>
                <div style="color:#6b7280;font-size:.9rem;">${(file.size/1024).toFixed(2)} –ö–ë</div>
              </div>
            </div>
            <button class="remove-file" onclick="removeFile(this)" data-file="${file.name}">‚úï</button>`;
          filesList.appendChild(li);
          await parseCSVFile(file);
        }
      }

      if (allData.length > 0){
        filtersSection.style.display = 'block';
        updateStats();
        setupColumns();
        setupKeywordColumnsChips();

        currentFilter = 'all';
        filteredData = [...allData];
        displayResults(filteredData);
        showToast('–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
      }
    }

    async function parseCSVFile(file){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          Papa.parse(text, {
            header:true, delimiter:';', skipEmptyLines:true, dynamicTyping:true, encoding:'windows-1251',
            complete: (results) => {
              results.data.forEach(row => { row['–ò—Å—Ç–æ—á–Ω–∏–∫'] = file.name; });
              allData = [...allData, ...results.data];
              resolve();
            }
          });
        };
        reader.readAsText(file, 'windows-1251');
      });
    }

    function removeFile(btn){
      const fileName = btn.getAttribute('data-file');
      allData = allData.filter(row => row['–ò—Å—Ç–æ—á–Ω–∏–∫'] !== fileName);
      btn.parentElement.remove();
      if (allData.length === 0){
        document.getElementById('filtersSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
      } else {
        updateStats();
        filteredData = [...allData];
        displayResults(filteredData);
        setupKeywordColumnsChips();
      }
    }

    function updateStats(){
      const streetCount = allData.filter(row =>
        row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
        String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
      ).length;

      const smrCount = allData.filter(row => {
        const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
        if (!name) return false;
        const low = String(name).toLowerCase();
        return (String(name).includes('–ö–õ-') ||
                String(name).includes('–í–õ-') ||
                (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                String(name).includes('–ë–ö–¢–ü'));
      }).length;

      const totalSum = allData.reduce((sum, row) => sum + (row['–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞'] || 0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${allData.length}</div><div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div></div>
        <div class="stat-card"><div class="stat-value">${streetCount}</div><div class="stat-label">–£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</div></div>
        <div class="stat-card"><div class="stat-value">${smrCount}</div><div class="stat-label">–°–ú–†</div></div>
        <div class="stat-card"><div class="stat-value">${formatMoney(totalSum)}</div><div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div></div>`;
    }

    function setupColumns(){
      if (!allData.length) return;
      const columns = Object.keys(allData[0]);
      selectedColumns = [
        '–†–µ–µ—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
        '–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞','–î–∞—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è','–≠—Ç–∞–ø –∑–∞–∫—É–ø–∫–∏','–ò—Å—Ç–æ—á–Ω–∏–∫'
      ].filter(c => columns.includes(c));
      columns.forEach(c => { if (!selectedColumns.includes(c)) selectedColumns.push(c); });

      const grid = document.getElementById('columnsGrid');
      grid.innerHTML = '';
      selectedColumns.forEach(col => {
        const id = `col_${col.replace(/\s/g,'_')}`;
        const div = document.createElement('div');
        div.className = 'column-checkbox';
        div.innerHTML = `<input type="checkbox" id="${id}" value="${col}" checked onchange="updateSelectedColumns()">
                         <label for="${id}">${col}</label>`;
        grid.appendChild(div);
      });
    }

    // –ß–∏–ø—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞
    function setupKeywordColumnsChips(){
      const wrap = document.getElementById('kwColumns');
      wrap.innerHTML = '';
      keywordSearchColumns = new Set();

      const available = allData.length ? Object.keys(allData[0]) : [];
      const initial = defaultKeywordColumns.filter(c => available.includes(c));
      if (!initial.length && available.includes('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏')) initial.push('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏');
      initial.forEach(c => keywordSearchColumns.add(c));

      available.forEach(col => {
        const id = `kwcol_${col.replace(/\s/g,'_')}`;
        const el = document.createElement('label');
        el.className = 'kw-col';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${col}" ${keywordSearchColumns.has(col)?'checked':''} onchange="toggleKeywordColumn(this)">
                        <span>${col}</span>`;
        wrap.appendChild(el);
      });
    }

    function toggleKeywordColumn(cb){
      const col = cb.value;
      if (cb.checked) keywordSearchColumns.add(col);
      else keywordSearchColumns.delete(col);
      if (keywordSearchColumns.size === 0){
        cb.checked = true;
        keywordSearchColumns.add(col);
        showToast('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞','error');
      }
    }

    function updateSelectedColumns(){
      selectedColumns = [];
      document.querySelectorAll('.column-checkbox input:checked').forEach(cb => selectedColumns.push(cb.value));
      if (filteredData.length) displayResults(filteredData);
    }

    function toggleColumnSelector(){
      const selector = document.getElementById('columnSelector');
      selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    }

    function applyFilter(type){
      currentFilter = type;
      switch(type){
        case 'street':
          filteredData = allData.filter(row =>
            row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
            String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
          );
          showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π —É–ª–∏—á–Ω–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è`,'success');
          break;
        case 'smr':
          filteredData = allData.filter(row => {
            const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
            if (!name) return false;
            const low = String(name).toLowerCase();
            return (String(name).includes('–ö–õ-') ||
                    String(name).includes('–í–õ-') ||
                    (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                    String(name).includes('–ë–ö–¢–ü'));
          });
          showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π –°–ú–†`,'success');
          break;
        case 'all':
        default:
          filteredData = [...allData];
          showToast(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`,'info');
          break;
      }
      // —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞
      sortColumn = '';
      sortDirection = 'asc';
      displayResults(filteredData);
    }

    function displayResults(data){
      const resultsSection = document.getElementById('resultsSection');
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const noResults  = document.getElementById('noResults');

      resultsSection.style.display = 'block';

      if (!data || !data.length){
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';

      const displayCols = selectedColumns.filter(col => document.querySelector(`input[value="${col}"]:checked`));
      tableHead.innerHTML = '<tr>' + displayCols.map(col => `<th onclick="sortTable('${col}')">${col} ${getSortIcon(col)}</th>`).join('') + '</tr>';

      tableBody.innerHTML = data.map(row =>
        `<tr>${displayCols.map(col => `<td>${formatCellValue(row[col]) ?? ''}</td>`).join('')}</tr>`
      ).join('');
    }

    function formatCellValue(val){
      if (val === null || val === undefined) return '';
      if (typeof val === 'number' && !isNaN(val)) return formatMoney(val);
      return String(val);
    }

    function formatMoney(amount){
      if (!amount) return '‚Äî';
      return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:0,maximumFractionDigits:2}).format(amount);
    }

    function getSortIcon(column){ if (sortColumn !== column) return '‚ÜïÔ∏è'; return sortDirection === 'asc' ? '‚Üë' : '‚Üì'; }

    function sortTable(column){
      if (sortColumn === column){ sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc'); }
      else { sortColumn = column; sortDirection = 'asc'; }
      filteredData.sort((a,b) => compareValues(a[column], b[column]));
      displayResults(filteredData);
    }

    function compareValues(a, b){
      let av = a, bv = b;
      if (av === null || av === undefined) av = '';
      if (bv === null || bv === undefined) bv = '';
      if (typeof av === 'number' && typeof bv === 'number')
        return (sortDirection === 'asc' ? av - bv : bv - av);
      av = String(av).toLowerCase(); bv = String(bv).toLowerCase();
      return (sortDirection === 'asc' ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1));
    }

    function searchTable(term){
      if (!term){ displayResults(filteredData); return; }
      const needle = term.toLowerCase();
      const res = filteredData.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(needle)));
      displayResults(res);
    }

    function exportToCSV(){
      if (!filteredData.length){ showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','error'); return; }
      const displayCols = selectedColumns.filter(col => document.querySelector(`input[value="${col}"]:checked`));
      const exportData = filteredData.map(row => { const out = {}; displayCols.forEach(c => out[c] = row[c]); return out; });
      const csv = Papa.unparse(exportData, { delimiter:';', header:true });
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); const url = URL.createObjectURL(blob);
      const dateStr = new Date().toLocaleDateString('ru-RU').replace(/\./g,'-');
      const filterName = currentFilter === 'street' ? '–£–ª–∏—á–Ω–æ–µ–û—Å–≤–µ—â–µ–Ω–∏–µ'
                        : currentFilter === 'smr'    ? '–°–ú–†'
                        : currentFilter === 'keyword'? '–ö–ª—é—á–µ–≤—ã–µ–°–ª–æ–≤–∞'
                        : '–í—Å–µ';
      link.href = url; link.download = `–†–µ–µ—Å—Ç—Ä_${filterName}_${dateStr}.csv`; link.style.visibility='hidden';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      showToast(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å–µ–π`,'success');
    }

    function showToast(msg, type='info'){
      const toast = document.getElementById('toast');
      toast.textContent = msg; toast.className = 'toast';
      if (type === 'success') toast.classList.add('success');
      if (type === 'error') toast.classList.add('error');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ====== –ü–û–ò–°–ö –ü–û –ö–õ–Æ–ß–ï–í–´–ú –°–õ–û–í–ê–ú ======
    function addKeywordField(){
      const wrap = document.getElementById('keywordInputs');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'keyword-input';
      input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É';
      wrap.appendChild(input);
      input.focus();
    }

    function performKeywordSearch(){
      const inputs = document.querySelectorAll('.keyword-input');
      const keywords = [];
      inputs.forEach(i => {
        const t = i.value.trim().toLowerCase();
        if (t) keywords.push(t);
      });
      if (!keywords.length){ showToast('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ','error'); return; }

      const logic = document.querySelector('input[name="kwLogic"]:checked')?.value || 'OR';
      const strict = document.getElementById('kwStrict').checked;

      const cols = Array.from(keywordSearchColumns);
      if (!cols.length){ showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞','error'); return; }

      currentFilter = 'keyword';

      // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–≥–µ–∫—Å–ø–æ–≤ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ —Ä–µ–∂–∏–º–∞
      const regs = strict ? keywords.map(k => buildWordRegex(k)) : null;

      filteredData = allData.filter(row => rowMatches(row, cols, keywords, strict, logic, regs));

      // —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      sortColumn = '';
      sortDirection = 'asc';

      showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º`,'success');
      displayResults(filteredData);
    }

    function rowMatches(row, cols, keywords, strict, logic, regs){
      // –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ–ª–æ–Ω–∫–∞–º –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
      const values = cols.map(c => String(row[c] ?? '').toLowerCase());

      const matchKeyword = (kw, idx) => {
        if (strict){
          const re = regs ? regs[idx] : buildWordRegex(kw);
          return values.some(v => re.test(v));
        } else {
          return values.some(v => v.includes(kw));
        }
      };

      if (logic === 'AND'){
        return keywords.every((kw, i) => matchKeyword(kw, i));
      } else { // OR
        return keywords.some((kw, i) => matchKeyword(kw, i));
      }
    }

    // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä–µ–≥–µ–∫—Å–ø–∞ –¥–ª—è —Å—Ç—Ä–æ–≥–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ¬´—Ü–µ–ª–æ–≥–æ —Å–ª–æ–≤–∞¬ª (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π)
    function buildWordRegex(kw){
      const escaped = escapeRegExp(kw);
      // ¬´–ì—Ä–∞–Ω–∏—Ü–∞¬ª ‚Äî –Ω–µ –±—É–∫–≤–∞/—Ü–∏—Ñ—Ä–∞/–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ –ø–æ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã (Unicode –∫–ª–∞—Å—Å)
      const pattern = `(^|[^\\p{L}\\p{N}_])${escaped}([^\\p{L}\\p{N}_]|$)`;
      return new RegExp(pattern, 'iu');
    }

    function escapeRegExp(s){
      return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ====== –°–ë–†–û–° ======
    function resetFilters(){
      // –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä
      filteredData = [...allData];
      currentFilter = 'all';

      // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
      const keywordInputs = document.getElementById('keywordInputs');
      keywordInputs.innerHTML = '<input type="text" class="keyword-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É">';

      // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ–∏—Å–∫–∞ –∫ –¥–µ—Ñ–æ–ª—Ç—É
      setupKeywordColumnsChips();

      // –°–±—Ä–æ—Å –ª–æ–≥–∏–∫–∏ –ò/–ò–õ–ò –∏ —Å—Ç—Ä–æ–≥–æ–≥–æ —Ä–µ–∂–∏–º–∞
      document.querySelector('input[name="kwLogic"][value="OR"]').checked = true;
      document.getElementById('kwStrict').checked = false;

      // –û—á–∏—Å—Ç–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
      const tableSearch = document.getElementById('searchInput');
      if (tableSearch) tableSearch.value = '';

      // –°–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      sortColumn = '';
      sortDirection = 'asc';

      // –°–ø—Ä—è—Ç–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ (–µ—Å–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç)
      const selector = document.getElementById('columnSelector');
      if (selector) selector.style.display = 'none';

      updateStats();
      displayResults(filteredData);
      showToast('–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º —Å–±—Ä–æ—à–µ–Ω—ã','info');
    }
  </script>
</body>
</html>
