<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫ - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2563eb;--primary-dark:#1e40af;
      --secondary:#10b981;--secondary-dark:#059669;
      --danger:#ef4444;--warning:#f59e0b;
      --dark:#1f2937;--light:#f3f4f6;--border:#e5e7eb;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px;animation:slideDown .5s ease-out}
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    h1{color:var(--dark);font-size:2.5rem;margin-bottom:10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:#6b7280;font-size:1.1rem}
    .upload-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px;animation:slideUp .6s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .upload-area{border:3px dashed var(--border);border-radius:15px;padding:40px;text-align:center;transition:all .3s ease;cursor:pointer;background:linear-gradient(145deg,#f9fafb,#fff)}
    .upload-area:hover{border-color:var(--primary);background:linear-gradient(145deg,#eff6ff,#fff);transform:translateY(-2px)}
    .upload-area.dragover{border-color:var(--secondary);background:linear-gradient(145deg,#d1fae5,#fff)}
    .upload-icon{font-size:3rem;color:var(--primary);margin-bottom:15px}
    .file-input{display:none}
    .files-list{margin-top:20px;padding:0;list-style:none}
    .file-item{background:var(--light);padding:15px;margin:10px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center;transition:all .3s ease}
    .file-item:hover{transform:translateX(5px);box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .file-info{display:flex;align-items:center;gap:15px}
    .file-icon{color:var(--secondary);font-size:1.5rem}
    .remove-file{background:var(--danger);color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;transition:all .3s ease}
    .remove-file:hover{background:#dc2626;transform:scale(1.05)}
    .filters-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);margin-bottom:30px}
    .filter-buttons{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:20px}
    .filter-btn{padding:12px 25px;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}
    .filter-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:rgba(255,255,255,.3);transition:left .3s ease}
    .filter-btn:hover::before{left:100%}
    .filter-btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}
    .filter-btn.secondary{background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:#fff}
    .filter-btn.warning{background:linear-gradient(135deg,var(--warning),#dc2626);color:#fff}
    .filter-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px -5px rgba(0,0,0,.2)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:20px}
    .stat-card{background:linear-gradient(145deg,#f9fafb,#fff);padding:20px;border-radius:15px;border:1px solid var(--border);transition:all .3s ease}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px -5px rgba(0,0,0,.1)}
    .stat-value{font-size:2rem;font-weight:bold;color:var(--dark);margin-bottom:5px}
    .stat-label{color:#6b7280;font-size:.9rem}
    .results-section{background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);display:none;animation:fadeIn .5s ease-out}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
    .search-box{display:flex;gap:10px;flex:1;max-width:400px}
    .search-input{flex:1;padding:10px 15px;border:2px solid var(--border);border-radius:10px;font-size:1rem;transition:all .3s ease}
    .search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .export-section{display:flex;gap:10px}
    .export-btn{padding:10px 20px;background:var(--secondary);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s ease}
    .export-btn:hover{background:var(--secondary-dark);transform:translateY(-2px)}
    .table-container{overflow-x:auto;border-radius:15px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:15px;text-align:left;font-weight:600;position:sticky;top:0;cursor:pointer;user-select:none}
    th:hover{background:linear-gradient(135deg,#4f46e5,#7c3aed)}
    th:first-child{border-top-left-radius:15px}th:last-child{border-top-right-radius:15px}
    td{padding:15px;border-bottom:1px solid var(--border)}
    tr:nth-child(even){background:var(--light)}
    tr:hover{background:#eff6ff;transition:background .3s ease}
    .highlight{background:#fef3c7 !important;animation:pulse 1s ease-in-out}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}
    .column-selector{margin-bottom:20px;padding:20px;background:var(--light);border-radius:15px}
    .column-selector h3{margin-bottom:15px;color:var(--dark)}
    .columns-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
    .column-checkbox{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;transition:background .3s ease}
    .column-checkbox:hover{background:#fff}
    .column-checkbox input{width:18px;height:18px;cursor:pointer}
    .column-checkbox label{cursor:pointer;font-size:.95rem}
    .loading{display:none;text-align:center;padding:50px}
    .loading.active{display:block}
    .spinner{width:50px;height:50px;border:4px solid var(--light);border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .no-results{text-align:center;padding:50px;color:#6b7280}
    .toast{position:fixed;bottom:30px;right:30px;padding:15px 25px;background:var(--dark);color:#fff;border-radius:10px;box-shadow:0 10px 25px -5px rgba(0,0,0,.3);opacity:0;transform:translateY(20px);transition:all .3s ease;z-index:1000}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--secondary)}
    .toast.error{background:var(--danger)}
    /* –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ */
    .keyword-search{margin-top:20px;padding:16px;border:1px dashed var(--border);border-radius:12px;background:linear-gradient(145deg,#fafafa,#fff)}
    .keyword-input{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-size:1rem}
    .keyword-input + .keyword-input{margin-top:10px}
    .kw-columns{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .kw-col{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–∞–∫—É–ø–æ–∫</h1>
      <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: –£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ –∏ –°–ú–†</p>
    </div>

    <div class="upload-section">
      <h2 style="margin-bottom:20px;">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üì§</div>
        <p style="font-size:1.1rem;margin-bottom:10px;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
        <p style="color:#6b7280;">–∏–ª–∏</p>
        <button class="filter-btn primary" style="margin-top:15px;">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
      </div>
      <ul class="files-list" id="filesList"></ul>
    </div>

    <div class="filters-section" id="filtersSection" style="display:none;">
      <h2 style="margin-bottom:20px;">üîç –§–∏–ª—å—Ç—Ä—ã –∏ –∞–Ω–∞–ª–∏–∑</h2>

      <div class="filter-buttons">
        <button class="filter-btn primary"   onclick="applyFilter('street')">üí° –£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ (–Ω–∞—Ä—É–∂*)</button>
        <button class="filter-btn secondary" onclick="applyFilter('smr')">üîß –°–ú–† (–ö–õ-, –í–õ-, –¢–ü, –ë–ö–¢–ü)</button>
        <button class="filter-btn warning"   onclick="applyFilter('all')">üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏</button>
        <button class="filter-btn warning"   onclick="resetFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
      </div>

      <div class="stats" id="stats"></div>

      <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º -->
      <div class="keyword-search" id="keywordSearch">
        <h3 style="margin-bottom:10px;">üîé –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</h3>
        <div id="keywordInputs">
          <input type="text" class="keyword-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É">
        </div>

        <!-- –ö–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
        <div id="kwColumns" class="kw-columns"></div>

        <div id="keywordActions" style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="filter-btn secondary" id="addKeywordBtn"  type="button">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
          <button class="filter-btn primary"   id="startSearchBtn" type="button">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫</button>
        </div>
      </div>
    </div>

    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</h2>
        <div class="search-box">
          <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ...">
        </div>
        <div class="export-section">
          <button class="export-btn" onclick="toggleColumnSelector()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button class="export-btn" onclick="exportToCSV()">üíæ –°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
      </div>

      <div class="column-selector" id="columnSelector" style="display:none;">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞:</h3>
        <div class="columns-grid" id="columnsGrid"></div>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>

      <div class="table-container">
        <table id="resultsTable">
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="no-results" id="noResults" style="display:none;">
        <p style="font-size:1.5rem;margin-bottom:10px;">üòï –ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    let allData = [];
    let filteredData = [];
    let selectedColumns = [];
    let sortColumn = '';
    let sortDirection = 'asc';
    let currentFilter = '';

    // –ö–æ–ª–æ–Ω–∫–∏, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    const defaultKeywordColumns = [
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏',
      '–û–ø–∏—Å–∞–Ω–∏–µ',
      '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
      '–ú–µ—Å—Ç–æ –ø–æ—Å—Ç–∞–≤–∫–∏'
    ];
    let keywordSearchColumns = new Set(); // —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ

    document.addEventListener('DOMContentLoaded', () => {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput  = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);

      uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
      uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

      document.getElementById('searchInput').addEventListener('input', (e) => searchTable(e.target.value));

      document.getElementById('addKeywordBtn').addEventListener('click', addKeywordField);
      document.getElementById('startSearchBtn').addEventListener('click', performKeywordSearch);
    });

    function handleFileSelect(e){ handleFiles(e.target.files); }

    async function handleFiles(files){
      const filesList = document.getElementById('filesList');
      const filtersSection = document.getElementById('filtersSection');
      showToast('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...', 'info');

      for (let file of files){
        if (file.type === 'text/csv' || file.name.endsWith('.csv')){
          const li = document.createElement('li');
          li.className = 'file-item';
          li.innerHTML = `
            <div class="file-info">
              <span class="file-icon">üìÑ</span>
              <div>
                <div style="font-weight:600;">${file.name}</div>
                <div style="color:#6b7280;font-size:.9rem;">${(file.size/1024).toFixed(2)} –ö–ë</div>
              </div>
            </div>
            <button class="remove-file" onclick="removeFile(this)" data-file="${file.name}">‚úï</button>`;
          filesList.appendChild(li);
          await parseCSVFile(file);
        }
      }

      if (allData.length > 0){
        filtersSection.style.display = 'block';
        updateStats();
        setupColumns();
        setupKeywordColumnsChips(); // <‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º —á–∏–ø—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞

        currentFilter = 'all';
        filteredData = [...allData];
        displayResults(filteredData);
        showToast('–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
      }
    }

    async function parseCSVFile(file){
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          Papa.parse(text, {
            header:true, delimiter:';', skipEmptyLines:true, dynamicTyping:true, encoding:'windows-1251',
            complete: (results) => {
              results.data.forEach(row => { row['–ò—Å—Ç–æ—á–Ω–∏–∫'] = file.name; });
              allData = [...allData, ...results.data];
              resolve();
            }
          });
        };
        reader.readAsText(file, 'windows-1251');
      });
    }

    function removeFile(btn){
      const fileName = btn.getAttribute('data-file');
      allData = allData.filter(row => row['–ò—Å—Ç–æ—á–Ω–∏–∫'] !== fileName);
      btn.parentElement.remove();
      if (allData.length === 0){
        document.getElementById('filtersSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
      } else {
        updateStats();
        filteredData = [...allData];
        displayResults(filteredData);
        setupKeywordColumnsChips();
      }
    }

    function updateStats(){
      const streetCount = allData.filter(row =>
        row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
        String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
      ).length;

      const smrCount = allData.filter(row => {
        const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
        if (!name) return false;
        const low = String(name).toLowerCase();
        return (String(name).includes('–ö–õ-') ||
                String(name).includes('–í–õ-') ||
                (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                String(name).includes('–ë–ö–¢–ü'));
      }).length;

      const totalSum = allData.reduce((sum, row) => sum + (row['–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞'] || 0), 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-value">${allData.length}</div><div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div></div>
        <div class="stat-card"><div class="stat-value">${streetCount}</div><div class="stat-label">–£–ª–∏—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</div></div>
        <div class="stat-card"><div class="stat-value">${smrCount}</div><div class="stat-label">–°–ú–†</div></div>
        <div class="stat-card"><div class="stat-value">${formatMoney(totalSum)}</div><div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div></div>`;
    }

    function setupColumns(){
      if (allData.length === 0) return;
      const columns = Object.keys(allData[0]);
      selectedColumns = [
        '–†–µ–µ—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫–∞',
        '–ù–∞—á–∞–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è) —Ü–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞','–î–∞—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è','–≠—Ç–∞–ø –∑–∞–∫—É–ø–∫–∏','–ò—Å—Ç–æ—á–Ω–∏–∫'
      ].filter(c => columns.includes(c));
      columns.forEach(c => { if (!selectedColumns.includes(c)) selectedColumns.push(c); });

      const grid = document.getElementById('columnsGrid');
      grid.innerHTML = '';
      selectedColumns.forEach(col => {
        const id = `col_${col.replace(/\s/g,'_')}`;
        const div = document.createElement('div');
        div.className = 'column-checkbox';
        div.innerHTML = `<input type="checkbox" id="${id}" value="${col}" checked onchange="updateSelectedColumns()">
                         <label for="${id}">${col}</label>`;
        grid.appendChild(div);
      });
    }

    // –ß–∏–ø—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    function setupKeywordColumnsChips(){
      const wrap = document.getElementById('kwColumns');
      wrap.innerHTML = '';
      keywordSearchColumns = new Set(); // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞

      // –ö–∞–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ä–µ–∞–ª—å–Ω–æ:
      const available = allData.length ? Object.keys(allData[0]) : [];

      // –ë–µ—Ä—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
      const initial = defaultKeywordColumns.filter(c => available.includes(c));
      // –ï—Å–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –Ω–µ—Ç, –≤–æ–∑—å–º—ë–º —Ö–æ—Ç—è –±—ã ¬´–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (!initial.length && available.includes('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏')) initial.push('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏');

      // –û—Ç–º–µ—Ç–∏–º –∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      initial.forEach(c => keywordSearchColumns.add(c));

      // –†–∏—Å—É–µ–º —á–∏–ø—Å—ã –¥–ª—è –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–Ω–æ –Ω–∞—á–∞–ª—å–Ω—ã–µ ‚Äî –≤–∫–ª—é—á–µ–Ω—ã)
      available.forEach(col => {
        const id = `kwcol_${col.replace(/\s/g,'_')}`;
        const div = document.createElement('label');
        div.className = 'kw-col';
        div.innerHTML = `<input type="checkbox" id="${id}" value="${col}" ${keywordSearchColumns.has(col)?'checked':''} onchange="toggleKeywordColumn(this)">
                         <span>${col}</span>`;
        wrap.appendChild(div);
      });
    }

    function toggleKeywordColumn(cb){
      const col = cb.value;
      if (cb.checked) keywordSearchColumns.add(col);
      else keywordSearchColumns.delete(col);
      // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
      if (keywordSearchColumns.size === 0){
        cb.checked = true;
        keywordSearchColumns.add(col);
        showToast('–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞','error');
      }
    }

    function updateSelectedColumns(){
      selectedColumns = [];
      document.querySelectorAll('.column-checkbox input:checked').forEach(cb => selectedColumns.push(cb.value));
      if (filteredData.length > 0) displayResults(filteredData);
    }

    function toggleColumnSelector(){
      const selector = document.getElementById('columnSelector');
      selector.style.display = selector.style.display === 'none' ? 'block' : 'none';
    }

    function applyFilter(type){
      const loading = document.getElementById('loading');
      loading.classList.add('active');
      currentFilter = type;

      setTimeout(() => {
        switch(type){
          case 'street':
            filteredData = allData.filter(row =>
              row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'] &&
              String(row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏']).toLowerCase().includes('–Ω–∞—Ä—É–∂')
            );
            showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π —É–ª–∏—á–Ω–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è`,'success');
            break;
          case 'smr':
            filteredData = allData.filter(row => {
              const name = row['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏'];
              if (!name) return false;
              const low = String(name).toLowerCase();
              return (String(name).includes('–ö–õ-') ||
                      String(name).includes('–í–õ-') ||
                      (String(name).includes('–¢–ü') && !low.includes('–æ—Ç–ø—É')) ||
                      String(name).includes('–ë–ö–¢–ü'));
            });
            showToast(`–ù–∞–π–¥–µ–Ω–æ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π –°–ú–†`,'success');
            break;
          case 'all':
          default:
            filteredData = [...allData];
            showToast(`–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`,'info');
            break;
        }
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞
        sortColumn = '';
        sortDirection = 'asc';

        loading.classList.remove('active');
        displayResults(filteredData);
      }, 200);
    }

    function displayResults(data){
      const resultsSection = document.getElementById('resultsSection');
      const tableHead = document.getElementById('tableHead');
      const tableBody = document.getElementById('tableBody');
      const noResults  = document.getElementById('noResults');

      resultsSection.style.display = 'block';

      if (!data || data.length === 0){
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';

      const displayCols = selectedColumns.filter(col => document.querySelector(`input[value="${col}"]:checked`));
      tableHead.innerHTML = '<tr>' + displayCols.map(col => `<th onclick="sortTable('${col}')">${col} ${getSortIcon(col)}</th>`).join('') + '</tr>';

      tableBody.innerHTML = data.map((row, i) =>
        `<tr>
           ${displayCols.map(col => `<td>${formatCellValue(row[col]) ?? ''}</td>`).join('')}
         </tr>`
      ).join('');
    }

    function formatCellValue(val){
      if (val === null || val === undefined) return '';
      if (typeof val === 'number' && !isNaN(val)) return formatMoney(val);
      return String(val);
    }

    function formatMoney(amount){
      if (!amount) return '‚Äî';
      return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:0,maximumFractionDigits:2}).format(amount);
    }

    function getSortIcon(column){ if (sortColumn !== column) return '‚ÜïÔ∏è'; return sortDirection === 'asc' ? '‚Üë' : '‚Üì'; }

    function sortTable(column){
      if (sortColumn === column){ sortDirection = (sortDirection === 'asc' ? 'desc' : 'asc'); }
      else { sortColumn = column; sortDirection = 'asc'; }

      filteredData.sort((a,b) => {
        let av = a[column]; let bv = b[column];
        if (av === null || av === undefined) av = ''; if (bv === null || bv === undefined) bv = '';
        if (typeof av === 'number' && typeof bv === 'number') return (sortDirection === 'asc' ? av - bv : bv - av);
        av = String(av).toLowerCase(); bv = String(bv).toLowerCase();
        return (sortDirection === 'asc' ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1));
      });
      displayResults(filteredData);
    }

    function searchTable(term){
      if (!term){ displayResults(filteredData); return; }
      const needle = term.toLowerCase();
      const res = filteredData.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(needle)));
      displayResults(res);
    }

    function exportToCSV(){
      if (!filteredData.length){ showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞','error'); return; }
      const displayCols = selectedColumns.filter(col => document.querySelector(`input[value="${col}"]:checked`));
      const exportData = filteredData.map(row => {
        const out = {}; displayCols.forEach(c => out[c] = row[c]); return out;
      });
      const csv = Papa.unparse(exportData, { delimiter:';', header:true });
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); const url = URL.createObjectURL(blob);
      const dateStr = new Date().toLocaleDateString('ru-RU').replace(/\./g,'-');
      const filterName = currentFilter === 'street' ? '–£–ª–∏—á–Ω–æ–µ–û—Å–≤–µ—â–µ–Ω–∏–µ' :
                         currentFilter === 'smr'    ? '–°–ú–†' :
                         currentFilter === 'keyword'? '–ö–ª—é—á–µ–≤—ã–µ–°–ª–æ–≤–∞' : '–í—Å–µ';
      link.href = url; link.download = `–†–µ–µ—Å—Ç—Ä_${filterName}_${dateStr}.csv`; link.style.visibility='hidden';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      showToast(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${exportData.length} –∑–∞–ø–∏—Å–µ–π`,'success');
    }

    function showToast(msg, type='info'){
      const toast = document.getElementById('toast');
      toast.textContent = msg; toast.className = 'toast';
      if (type === 'success') toast.classList.add('success');
      if (type === 'error') toast.classList.add('error');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ====== –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê ======
    function addKeywordField(){
      const wrap = document.getElementById('keywordInputs');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'keyword-input';
      input.placeholder = '–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É';
      wrap.appendChild(input);
      input.focus();
    }

    function performKeywordSearch(){
      const inputs = document.querySelectorAll('.keyword-input');
      const keywords = [];
      inputs.forEach(i => {
        const t = i.value.trim().toLowerCase();
        if (t) keywords.push(t);
      });

      if (!keywords.length){
        showToast('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ','error');
        return;
      }

      // –∫–æ–ª–æ–Ω–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∏—Å–∫–∞—Ç—å
      const cols = Array.from(keywordSearchColumns);
      if (!cols.length){
        showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞','error');
        return;
      }

      currentFilter = 'keyword';
      const results = allData.filter(row => {
        return cols.some(col => {
          const val = String(row[col] ?? '').toLowerCase();
          return keywords.some(k => val.includes(k));
        });
      });

      filteredData = results;

      // —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞
      sortColumn = '';
      sortDirection = 'asc';

      showToast(`–ù–∞–π–¥–µ–Ω–æ ${results.length} –∑–∞–ø–∏—Å–µ–π –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º`,'success');
      displayResults(results);
    }

    // ====== –°–ë–†–û–° ======
    function resetFilters(){
      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä
      filteredData = [...allData];
      currentFilter = 'all';

      // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ–¥–Ω–æ –ø—É—Å—Ç–æ–µ
      const keywordInputs = document.getElementById('keywordInputs');
      keywordInputs.innerHTML = '<input type="text" class="keyword-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑—É">';

      // —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ ‚Äî –≤–µ—Ä–Ω—ë–º –∫ –¥–µ—Ñ–æ–ª—Ç—É
      setupKeywordColumnsChips();

      // –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤—ã–π –ø–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
      const tableSearch = document.getElementById('searchInput');
      if (tableSearch) tableSearch.value = '';

      // —Å–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      sortColumn = '';
      sortDirection = 'asc';

      // —Å–ø—Ä—è—Ç–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–ª–æ–Ω–æ–∫ (–µ—Å–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç)
      const selector = document.getElementById('columnSelector');
      if (selector) selector.style.display = 'none';

      updateStats();
      displayResults(filteredData);
      showToast('–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º —Å–±—Ä–æ—à–µ–Ω—ã','info');
    }
  </script>
</body>
</html>
